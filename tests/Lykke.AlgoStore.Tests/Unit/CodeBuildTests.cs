using System;
using Lykke.AlgoStore.Core.Domain.Validation;
using Lykke.AlgoStore.Core.Validation;
using Lykke.AlgoStore.Services;
using NUnit.Framework;
using System.Linq;
using System.Text;
using Newtonsoft.Json;

namespace Lykke.AlgoStore.Tests.Unit
{
    [TestFixture]
    public class CodeBuildTests
    {
        [Test]
        public void SyntaxValidation_Fails_WhenNoClassInheritsBaseAlgo()
        {
            var code = "class A {} class B : C {}";

            var result = When_Code_IsSyntaxValidated(code);

            Then_Result_MustFailAndContainMessages(result);
            Then_Result_MustContainMessage(result, "AS0001");
        }

        [Test]
        public void SyntaxValidation_Fails_WhenMultipleClassesInheritBaseAlgo()
        {
            var code = "class A : BaseAlgo {} class B : BaseAlgo {}";

            var result = When_Code_IsSyntaxValidated(code);

            Then_Result_MustFailAndContainMessages(result);
            Then_Result_MustContainMessage(result, "AS0002");
        }

        [Test]
        public void SyntaxValidation_Fails_WhenAlgoNotSealed()
        {
            var code = "class A : BaseAlgo {}";

            var result = When_Code_IsSyntaxValidated(code);

            Then_Result_MustFailAndContainMessages(result);
            Then_Result_MustContainMessage(result, "AS0003");
        }

        [Test]
        public void SyntaxValidation_Fails_WhenTypeNamedBaseAlgo()
        {
            var code = "interface BaseAlgo {} enum BaseAlgo {} class BaseAlgo {} struct BaseAlgo {}";

            var result = When_Code_IsSyntaxValidated(code);

            Then_Result_MustFailAndContainMessages(result);
            Then_Result_MustContainMessageNTimes(result, "AS0004", 4);
        }

        [Test]
        public void SyntaxValidation_Fails_WhenEventsNotImplemented()
        {
            var code = "class A : BaseAlgo {void A() {} void OnCandleReceived() {}}";

            var result = When_Code_IsSyntaxValidated(code);

            Then_Result_MustFailAndContainMessages(result);
            Then_Result_MustContainMessage(result, "AS0005");
        }

        [Test]
        public void SyntaxValidation_Succeeds_WhenAlgoProperlyImplemented()
        {
            var code = @"using Lykke.AlgoStore.CSharp.AlgoTemplate.Abstractions.Core.Domain; 
                         sealed class A : BaseAlgo 
                         { 
                            public override void OnCandleReceived(ICandleContext context) {} 
                         }";

            var result = When_Code_IsSyntaxValidated(code);

            Then_Result_MustSucceedAndContainNoMessages(result);
        }

        [Test]
        public void ExtractMetadata_FromDummyAlgo_Succeeds_WhenAlgoProperlyImplemented()
        {
            var base64Content =
                "dXNpbmcgU3lzdGVtOw0KdXNpbmcgTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkNvcmUuRG9tYWluOw0KdXNpbmcgTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkZ1bmN0aW9ucy5TTUE7DQoNCm5hbWVzcGFjZSBMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ28uSW1wbGVtZW50aW9uDQp7DQogICAgLy8vIDxzdW1tYXJ5Pg0KICAgIC8vLyBSRU1BUks6IEp1c3QgYSBkdW1teSBhbGdvIGltcGxlbWVudGF0aW9uIGZvciBmdXR1cmUgcmVmZXJlbmNlLg0KICAgIC8vLyBXZSBjYW4gYW5kIHdpbGwgcmVtb3ZlIHRoaXMgd2hlbiBmaXJzdCBhbGdvIGlzIGltcGxlbWVudGVkIDopDQogICAgLy8vIDwvc3VtbWFyeT4NCiAgICBzZWFsZWQgY2xhc3MgRHVtbXlBbGdvIDogQmFzZUFsZ28NCiAgICB7DQogICAgICAgIHB1YmxpYyBTbWFGdW5jdGlvbiBfc2hvcnRTbWE7DQogICAgICAgIHB1YmxpYyBTbWFGdW5jdGlvbiBfbG9uZ1NtYTsNCg0KICAgICAgICBwdWJsaWMgb3ZlcnJpZGUgdm9pZCBPblN0YXJ0VXAoSUZ1bmN0aW9uUHJvdmlkZXIgZnVuY3Rpb25zKQ0KICAgICAgICB7DQoNCiAgICAgICAgICAgIF9zaG9ydFNtYSA9IGZ1bmN0aW9ucy5HZXRGdW5jdGlvbjxTbWFGdW5jdGlvbj4oIlNNQV9TaG9ydCIpOw0KICAgICAgICAgICAgX2xvbmdTbWEgPSBmdW5jdGlvbnMuR2V0RnVuY3Rpb248U21hRnVuY3Rpb24+KCJTTUFfTG9uZyIpOw0KICAgICAgICB9DQoNCiAgICAgICAgcHVibGljIG92ZXJyaWRlIHZvaWQgT25RdW90ZVJlY2VpdmVkKElRdW90ZUNvbnRleHQgY29udGV4dCkNCiAgICAgICAgew0KICAgICAgICAgICAgY29udGV4dC5BY3Rpb25zLkxvZygkIlZvbHVtZSB2YWx1ZToge1ZvbHVtZX0iKTsNCg0KICAgICAgICAgICAgdmFyIHF1b3RlID0gY29udGV4dC5EYXRhLlF1b3RlOw0KICAgICAgICAgICAgY29udGV4dC5BY3Rpb25zLkxvZygkIlJlY2VpdmluZyBxdW90ZSBhdCB7RGF0ZVRpbWUuVXRjTm93fSAiICsNCiAgICAgICAgICAgICAgICAkInt7cXVvdGUuUHJpY2U6IHtxdW90ZS5QcmljZX19fSwge3txdW90ZS5UaW1lc3RhbXA6IHtxdW90ZS5UaW1lc3RhbXB9fX0sICIgKw0KICAgICAgICAgICAgICAgICQie3txdW90ZS5Jc0J1eToge3F1b3RlLklzQnV5fX19LCB7e3F1b3RlLklzT25saW5lOiB7cXVvdGUuSXNPbmxpbmV9fX0iKTsNCg0KICAgICAgICAgICAgdmFyIHNtYVNob3J0ID0gX3Nob3J0U21hLlZhbHVlOw0KICAgICAgICAgICAgdmFyIHNtYUxvbmcgPSBfbG9uZ1NtYS5WYWx1ZTsNCiAgICAgICAgICAgIGNvbnRleHQuQWN0aW9ucy5Mb2coJCJGdW5jdGlvbiB2YWx1ZXMgYXJlOiBTTUFfU2hvcnQ6IHtzbWFTaG9ydH0sIFNNQV9Mb25nOiB7c21hTG9uZ30iKTsNCg0KICAgICAgICAgICAgLy9pZiAocXVvdGUuUHJpY2UgPCAxMDAwMCkNCiAgICAgICAgICAgIC8vew0KICAgICAgICAgICAgY29udGV4dC5BY3Rpb25zLkJ1eShWb2x1bWUpOw0KICAgICAgICAgICAgLy99DQoNCiAgICAgICAgICAgIC8vaWYgKHF1b3RlLlByaWNlID4gNzAwMCkNCiAgICAgICAgICAgIC8vew0KICAgICAgICAgICAgLy8gICAgY29udGV4dC5BY3Rpb25zLlNlbGwoVm9sdW1lKTsNCiAgICAgICAgICAgIC8vfQ0KICAgICAgICB9DQoNCg0KICAgICAgICBwdWJsaWMgb3ZlcnJpZGUgdm9pZCBPbkNhbmRsZVJlY2VpdmVkKElDYW5kbGVDb250ZXh0IGNvbnRleHQpDQogICAgICAgIHsNCiAgICAgICAgICAgIGNvbnRleHQuQWN0aW9ucy5Mb2coJCJWb2x1bWUgdmFsdWU6IHtWb2x1bWV9Iik7DQoNCiAgICAgICAgICAgIHZhciBjYW5kbGUgPSBjb250ZXh0LkRhdGEuQ2FuZGxlOw0KICAgICAgICAgICAgY29udGV4dC5BY3Rpb25zLkxvZygkIlJlY2VpdmluZyBjYW5kbGUgYXQge2NhbmRsZS5EYXRlVGltZX0gY2FuZGxlIGNsb3NlIFByaWNlIHtjYW5kbGUuQ2xvc2V9Iik7DQoNCiAgICAgICAgICAgIHZhciBzbWFTaG9ydCA9IF9zaG9ydFNtYS5WYWx1ZTsNCiAgICAgICAgICAgIHZhciBzbWFMb25nID0gX2xvbmdTbWEuVmFsdWU7DQogICAgICAgICAgICBjb250ZXh0LkFjdGlvbnMuTG9nKCQiRnVuY3Rpb24gdmFsdWVzIGFyZTogU01BX1Nob3J0OiB7c21hU2hvcnR9LCBTTUFfTG9uZzoge3NtYUxvbmd9Iik7DQoNCiAgICAgICAgICAgIC8vaWYgKHF1b3RlLlByaWNlIDwgMTAwMDApDQogICAgICAgICAgICAvL3sNCiAgICAgICAgICAgIC8vY29udGV4dC5BY3Rpb25zLkJ1eShjb250ZXh0LkRhdGEuQ2FuZGxlLCBWb2x1bWUpOw0KICAgICAgICAgICAgLy99DQoNCiAgICAgICAgICAgIC8vaWYgKHF1b3RlLlByaWNlID4gNzAwMCkNCiAgICAgICAgICAgIC8vew0KICAgICAgICAgICAgY29udGV4dC5BY3Rpb25zLlNlbGwoY29udGV4dC5EYXRhLkNhbmRsZSwgVm9sdW1lKTsNCiAgICAgICAgICAgIC8vfQ0KICAgICAgICB9DQogICAgfQ0KfQ==";
            var code = Encoding.UTF8.GetString(Convert.FromBase64String(base64Content));
            var session = GetCSharpCodeBuildSession(code);

            var validationResult = session.Validate().Result;

            Assert.AreEqual(true, validationResult.IsSuccessful);

            var metadata = session.ExtractMetadata().Result;
            var result = JsonConvert.SerializeObject(metadata);

            var base64Result = Convert.ToBase64String(Encoding.UTF8.GetBytes(result));

            Assert.AreEqual("eyJQYXJhbWV0ZXJzIjpbeyJLZXkiOiJBc3NldFBhaXIiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5TdHJpbmciLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkNhbmRsZUludGVydmFsIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5Nb2RlbHMuRW51bWVyYXRvcnMuQ2FuZGxlVGltZUludGVydmFsIiwiUHJlZGVmaW5lZFZhbHVlcyI6W3siS2V5IjoiMCIsIlZhbHVlIjoiVW5zcGVjaWZpZWQifSx7IktleSI6IjEiLCJWYWx1ZSI6IlNlYyJ9LHsiS2V5IjoiNjAiLCJWYWx1ZSI6Ik1pbnV0ZSJ9LHsiS2V5IjoiMzAwIiwiVmFsdWUiOiJNaW41In0seyJLZXkiOiI5MDAiLCJWYWx1ZSI6Ik1pbjE1In0seyJLZXkiOiIxODAwIiwiVmFsdWUiOiJNaW4zMCJ9LHsiS2V5IjoiMzYwMCIsIlZhbHVlIjoiSG91ciJ9LHsiS2V5IjoiMTQ0MDAiLCJWYWx1ZSI6IkhvdXI0In0seyJLZXkiOiIyMTYwMCIsIlZhbHVlIjoiSG91cjYifSx7IktleSI6IjQzMjAwIiwiVmFsdWUiOiJIb3VyMTIifSx7IktleSI6Ijg2NDAwIiwiVmFsdWUiOiJEYXkifSx7IktleSI6IjYwNDgwMCIsIlZhbHVlIjoiV2VlayJ9LHsiS2V5IjoiMzAwMDAwMCIsIlZhbHVlIjoiTW9udGgifV19LHsiS2V5IjoiU3RhcnRGcm9tIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uRGF0ZVRpbWUiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkVuZE9uIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uRGF0ZVRpbWUiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IlZvbHVtZSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRvdWJsZSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiVHJhZGVkQXNzZXQiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5TdHJpbmciLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfV0sIkZ1bmN0aW9ucyI6W3siVHlwZSI6Ikx5a2tlLkFsZ29TdG9yZS5DU2hhcnAuQWxnb1RlbXBsYXRlLkFic3RyYWN0aW9ucy5GdW5jdGlvbnMuU01BLlNtYUZ1bmN0aW9uIiwiSWQiOiJfc2hvcnRTbWEiLCJGdW5jdGlvblBhcmFtZXRlclR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5BYnN0cmFjdGlvbnMuRnVuY3Rpb25zLlNNQS5TbWFQYXJhbWV0ZXJzIiwiUGFyYW1ldGVycyI6W3siS2V5IjoiU2hvcnRUZXJtUGVyaW9kIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uSW50MzIiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkxvbmdUZXJtUGVyaW9kIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uSW50MzIiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkRlY2ltYWxzIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uTnVsbGFibGVgMVtbU3lzdGVtLkludDMyLCBTeXN0ZW0uUHJpdmF0ZS5Db3JlTGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49N2NlYzg1ZDdiZWE3Nzk4ZV1dIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJDYXBhY2l0eSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkludDMyIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJBc3NldFBhaXIiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5TdHJpbmciLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkNhbmRsZU9wZXJhdGlvbk1vZGUiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6Ikx5a2tlLkFsZ29TdG9yZS5DU2hhcnAuQWxnb1RlbXBsYXRlLkFic3RyYWN0aW9ucy5Db3JlLkZ1bmN0aW9ucy5GdW5jdGlvblBhcmFtc0Jhc2UrQ2FuZGxlVmFsdWUiLCJQcmVkZWZpbmVkVmFsdWVzIjpbeyJLZXkiOiIwIiwiVmFsdWUiOiJPUEVOIn0seyJLZXkiOiIxIiwiVmFsdWUiOiJDTE9TRSJ9LHsiS2V5IjoiMiIsIlZhbHVlIjoiTE9XIn0seyJLZXkiOiIzIiwiVmFsdWUiOiJISUdIIn1dfSx7IktleSI6IkZ1bmN0aW9uSW5zdGFuY2VJZGVudGlmaWVyIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uU3RyaW5nIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJTdGFydGluZ0RhdGUiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5EYXRlVGltZSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiRW5kaW5nRGF0ZSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRhdGVUaW1lIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJDYW5kbGVUaW1lSW50ZXJ2YWwiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6Ikx5a2tlLkFsZ29TdG9yZS5DU2hhcnAuQWxnb1RlbXBsYXRlLk1vZGVscy5FbnVtZXJhdG9ycy5DYW5kbGVUaW1lSW50ZXJ2YWwiLCJQcmVkZWZpbmVkVmFsdWVzIjpbeyJLZXkiOiIwIiwiVmFsdWUiOiJVbnNwZWNpZmllZCJ9LHsiS2V5IjoiMSIsIlZhbHVlIjoiU2VjIn0seyJLZXkiOiI2MCIsIlZhbHVlIjoiTWludXRlIn0seyJLZXkiOiIzMDAiLCJWYWx1ZSI6Ik1pbjUifSx7IktleSI6IjkwMCIsIlZhbHVlIjoiTWluMTUifSx7IktleSI6IjE4MDAiLCJWYWx1ZSI6Ik1pbjMwIn0seyJLZXkiOiIzNjAwIiwiVmFsdWUiOiJIb3VyIn0seyJLZXkiOiIxNDQwMCIsIlZhbHVlIjoiSG91cjQifSx7IktleSI6IjIxNjAwIiwiVmFsdWUiOiJIb3VyNiJ9LHsiS2V5IjoiNDMyMDAiLCJWYWx1ZSI6IkhvdXIxMiJ9LHsiS2V5IjoiODY0MDAiLCJWYWx1ZSI6IkRheSJ9LHsiS2V5IjoiNjA0ODAwIiwiVmFsdWUiOiJXZWVrIn0seyJLZXkiOiIzMDAwMDAwIiwiVmFsdWUiOiJNb250aCJ9XX1dfSx7IlR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5BYnN0cmFjdGlvbnMuRnVuY3Rpb25zLlNNQS5TbWFGdW5jdGlvbiIsIklkIjoiX2xvbmdTbWEiLCJGdW5jdGlvblBhcmFtZXRlclR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5BYnN0cmFjdGlvbnMuRnVuY3Rpb25zLlNNQS5TbWFQYXJhbWV0ZXJzIiwiUGFyYW1ldGVycyI6W3siS2V5IjoiU2hvcnRUZXJtUGVyaW9kIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uSW50MzIiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkxvbmdUZXJtUGVyaW9kIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uSW50MzIiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkRlY2ltYWxzIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uTnVsbGFibGVgMVtbU3lzdGVtLkludDMyLCBTeXN0ZW0uUHJpdmF0ZS5Db3JlTGliLCBWZXJzaW9uPTQuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49N2NlYzg1ZDdiZWE3Nzk4ZV1dIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJDYXBhY2l0eSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkludDMyIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJBc3NldFBhaXIiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5TdHJpbmciLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkNhbmRsZU9wZXJhdGlvbk1vZGUiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6Ikx5a2tlLkFsZ29TdG9yZS5DU2hhcnAuQWxnb1RlbXBsYXRlLkFic3RyYWN0aW9ucy5Db3JlLkZ1bmN0aW9ucy5GdW5jdGlvblBhcmFtc0Jhc2UrQ2FuZGxlVmFsdWUiLCJQcmVkZWZpbmVkVmFsdWVzIjpbeyJLZXkiOiIwIiwiVmFsdWUiOiJPUEVOIn0seyJLZXkiOiIxIiwiVmFsdWUiOiJDTE9TRSJ9LHsiS2V5IjoiMiIsIlZhbHVlIjoiTE9XIn0seyJLZXkiOiIzIiwiVmFsdWUiOiJISUdIIn1dfSx7IktleSI6IkZ1bmN0aW9uSW5zdGFuY2VJZGVudGlmaWVyIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uU3RyaW5nIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJTdGFydGluZ0RhdGUiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5EYXRlVGltZSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiRW5kaW5nRGF0ZSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRhdGVUaW1lIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJDYW5kbGVUaW1lSW50ZXJ2YWwiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6Ikx5a2tlLkFsZ29TdG9yZS5DU2hhcnAuQWxnb1RlbXBsYXRlLk1vZGVscy5FbnVtZXJhdG9ycy5DYW5kbGVUaW1lSW50ZXJ2YWwiLCJQcmVkZWZpbmVkVmFsdWVzIjpbeyJLZXkiOiIwIiwiVmFsdWUiOiJVbnNwZWNpZmllZCJ9LHsiS2V5IjoiMSIsIlZhbHVlIjoiU2VjIn0seyJLZXkiOiI2MCIsIlZhbHVlIjoiTWludXRlIn0seyJLZXkiOiIzMDAiLCJWYWx1ZSI6Ik1pbjUifSx7IktleSI6IjkwMCIsIlZhbHVlIjoiTWluMTUifSx7IktleSI6IjE4MDAiLCJWYWx1ZSI6Ik1pbjMwIn0seyJLZXkiOiIzNjAwIiwiVmFsdWUiOiJIb3VyIn0seyJLZXkiOiIxNDQwMCIsIlZhbHVlIjoiSG91cjQifSx7IktleSI6IjIxNjAwIiwiVmFsdWUiOiJIb3VyNiJ9LHsiS2V5IjoiNDMyMDAiLCJWYWx1ZSI6IkhvdXIxMiJ9LHsiS2V5IjoiODY0MDAiLCJWYWx1ZSI6IkRheSJ9LHsiS2V5IjoiNjA0ODAwIiwiVmFsdWUiOiJXZWVrIn0seyJLZXkiOiIzMDAwMDAwIiwiVmFsdWUiOiJNb250aCJ9XX1dfV19", base64Result);
        }

        [Test]
        public void ExtractMetadata_FromMacdTrendAlgo_Succeeds_WhenAlgoProperlyImplemented()
        {
            var base64Content =
                "dXNpbmcgTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkNvcmUuRG9tYWluOw0KdXNpbmcgTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkZ1bmN0aW9ucy5NQUNEOw0KDQpuYW1lc3BhY2UgTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvLkltcGxlbWVudGlvbg0Kew0KICAgIHNlYWxlZCBjbGFzcyBNYWNkVHJlbmRBbGdvIDogQmFzZUFsZ28NCiAgICB7DQogICAgICAgIHB1YmxpYyBkb3VibGUgSG9sZGluZ1N0ZXAgeyBnZXQ7IHNldDsgfQ0KICAgICAgICBwdWJsaWMgZG91YmxlIFRvbGVyYW5jZSB7IGdldDsgc2V0OyB9DQoNCiAgICAgICAgcHVibGljIE1hY2RGdW5jdGlvbiBfbWFjZDsNCiAgICAgICAgcHJpdmF0ZSBkb3VibGUgX2hvbGRpbmdzOw0KDQogICAgICAgIHB1YmxpYyBkb3VibGUgSG9sZGluZ3MgPT4gX2hvbGRpbmdzOw0KDQogICAgICAgIHB1YmxpYyBvdmVycmlkZSB2b2lkIE9uU3RhcnRVcChJRnVuY3Rpb25Qcm92aWRlciBmdW5jdGlvbnMpDQogICAgICAgIHsNCiAgICAgICAgICAgIF9tYWNkID0gZnVuY3Rpb25zLkdldEZ1bmN0aW9uPE1hY2RGdW5jdGlvbj4oIk1BQ0QiKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHB1YmxpYyBvdmVycmlkZSB2b2lkIE9uQ2FuZGxlUmVjZWl2ZWQoSUNhbmRsZUNvbnRleHQgY29udGV4dCkNCiAgICAgICAgew0KICAgICAgICAgICAgdmFyIGhpc3RvZ3JhbSA9IF9tYWNkLkhpc3RvZ3JhbTsNCiAgICAgICAgICAgIHZhciBmYXN0ID0gX21hY2QuRmFzdC5WYWx1ZTsNCg0KICAgICAgICAgICAgaWYgKGhpc3RvZ3JhbSA9PSBudWxsIHx8IGZhc3QgPT0gbnVsbCkNCiAgICAgICAgICAgICAgICByZXR1cm47DQoNCiAgICAgICAgICAgIHZhciBzaWduYWxEZWx0YVBlcmNlbnQgPSBoaXN0b2dyYW0gLyBmYXN0Ow0KDQogICAgICAgICAgICBjb250ZXh0LkFjdGlvbnMuTG9nKCQiRnVuY3Rpb24gdmFsdWVzIGFyZTogTWFjZCBoaXN0b2dyYW06IHtoaXN0b2dyYW19LCBNYWNkIGZhc3QgRU1BOiB7ZmFzdH0iKTsNCg0KICAgICAgICAgICAgaWYgKHNpZ25hbERlbHRhUGVyY2VudCA+IFRvbGVyYW5jZSkNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgYnV5aW5nL3NlbGxpbmcgd2hlbiB0cmFkaW5nIGxvZ2ljIGlzIGZpbmFsaXplZA0KICAgICAgICAgICAgICAgIC8vY29udGV4dC5BY3Rpb25zLkJ1eVN0cmFpZ2h0KEhPTERJTkdTX1NURVApOw0KICAgICAgICAgICAgICAgIF9ob2xkaW5ncyArPSBIb2xkaW5nU3RlcDsNCg0KICAgICAgICAgICAgICAgIGNvbnRleHQuQWN0aW9ucy5Mb2coJCJ7c2lnbmFsRGVsdGFQZXJjZW50fSBpcyBhYm92ZSB7VG9sZXJhbmNlfSwgYnV5aW5nIHtIb2xkaW5nU3RlcH0gbW9yZSBvZiB0aGUgYXNzZXQuICIgKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCJDdXJyZW50IGhvbGRpbmdzOiB7X2hvbGRpbmdzfSIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgZWxzZSBpZiAoX2hvbGRpbmdzID4gMCAmJiBzaWduYWxEZWx0YVBlcmNlbnQgPCAtVG9sZXJhbmNlKQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIC8vIFRPRE86IEltcGxlbWVudCBidXlpbmcvc2VsbGluZyB3aGVuIHRyYWRpbmcgbG9naWMgaXMgZmluYWxpemVkDQogICAgICAgICAgICAgICAgLy9jb250ZXh0LkFjdGlvbnMuU2VsbFN0cmFpZ2h0KF9ob2xkaW5ncyk7DQogICAgICAgICAgICAgICAgX2hvbGRpbmdzID0gMDsNCg0KICAgICAgICAgICAgICAgIGNvbnRleHQuQWN0aW9ucy5Mb2coJCJ7c2lnbmFsRGVsdGFQZXJjZW50fSBpcyBiZWxvdyB7LVRvbGVyYW5jZX0sIHNlbGxpbmcgYWxsIGhvbGRpbmdzLiIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KfQ==";
            var code = Encoding.UTF8.GetString(Convert.FromBase64String(base64Content));
            var session = GetCSharpCodeBuildSession(code);

            var validationResult = session.Validate().Result;

            Assert.AreEqual(true, validationResult.IsSuccessful);

            var metadata = session.ExtractMetadata().Result;
            var result = JsonConvert.SerializeObject(metadata);

            var base64Result = Convert.ToBase64String(Encoding.UTF8.GetBytes(result));

            Assert.AreEqual("eyJQYXJhbWV0ZXJzIjpbeyJLZXkiOiJIb2xkaW5nU3RlcCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRvdWJsZSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiVG9sZXJhbmNlIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uRG91YmxlIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJIb2xkaW5ncyIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRvdWJsZSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQXNzZXRQYWlyIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uU3RyaW5nIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJDYW5kbGVJbnRlcnZhbCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuTW9kZWxzLkVudW1lcmF0b3JzLkNhbmRsZVRpbWVJbnRlcnZhbCIsIlByZWRlZmluZWRWYWx1ZXMiOlt7IktleSI6IjAiLCJWYWx1ZSI6IlVuc3BlY2lmaWVkIn0seyJLZXkiOiIxIiwiVmFsdWUiOiJTZWMifSx7IktleSI6IjYwIiwiVmFsdWUiOiJNaW51dGUifSx7IktleSI6IjMwMCIsIlZhbHVlIjoiTWluNSJ9LHsiS2V5IjoiOTAwIiwiVmFsdWUiOiJNaW4xNSJ9LHsiS2V5IjoiMTgwMCIsIlZhbHVlIjoiTWluMzAifSx7IktleSI6IjM2MDAiLCJWYWx1ZSI6IkhvdXIifSx7IktleSI6IjE0NDAwIiwiVmFsdWUiOiJIb3VyNCJ9LHsiS2V5IjoiMjE2MDAiLCJWYWx1ZSI6IkhvdXI2In0seyJLZXkiOiI0MzIwMCIsIlZhbHVlIjoiSG91cjEyIn0seyJLZXkiOiI4NjQwMCIsIlZhbHVlIjoiRGF5In0seyJLZXkiOiI2MDQ4MDAiLCJWYWx1ZSI6IldlZWsifSx7IktleSI6IjMwMDAwMDAiLCJWYWx1ZSI6Ik1vbnRoIn1dfSx7IktleSI6IlN0YXJ0RnJvbSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRhdGVUaW1lIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJFbmRPbiIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRhdGVUaW1lIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJWb2x1bWUiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5Eb3VibGUiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IlRyYWRlZEFzc2V0IiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uU3RyaW5nIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH1dLCJGdW5jdGlvbnMiOlt7IlR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5BYnN0cmFjdGlvbnMuRnVuY3Rpb25zLk1BQ0QuTWFjZEZ1bmN0aW9uIiwiSWQiOiJfbWFjZCIsIkZ1bmN0aW9uUGFyYW1ldGVyVHlwZSI6Ikx5a2tlLkFsZ29TdG9yZS5DU2hhcnAuQWxnb1RlbXBsYXRlLkFic3RyYWN0aW9ucy5GdW5jdGlvbnMuTUFDRC5NYWNkUGFyYW1ldGVycyIsIlBhcmFtZXRlcnMiOlt7IktleSI6IlNsb3dFbWFQZXJpb2QiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5JbnQzMiIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiRmFzdEVtYVBlcmlvZCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkludDMyIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJTaWduYWxMaW5lUGVyaW9kIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uSW50MzIiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkFzc2V0UGFpciIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLlN0cmluZyIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQ2FuZGxlT3BlcmF0aW9uTW9kZSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkNvcmUuRnVuY3Rpb25zLkZ1bmN0aW9uUGFyYW1zQmFzZStDYW5kbGVWYWx1ZSIsIlByZWRlZmluZWRWYWx1ZXMiOlt7IktleSI6IjAiLCJWYWx1ZSI6Ik9QRU4ifSx7IktleSI6IjEiLCJWYWx1ZSI6IkNMT1NFIn0seyJLZXkiOiIyIiwiVmFsdWUiOiJMT1cifSx7IktleSI6IjMiLCJWYWx1ZSI6IkhJR0gifV19LHsiS2V5IjoiRnVuY3Rpb25JbnN0YW5jZUlkZW50aWZpZXIiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5TdHJpbmciLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IlN0YXJ0aW5nRGF0ZSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRhdGVUaW1lIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJFbmRpbmdEYXRlIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uRGF0ZVRpbWUiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkNhbmRsZVRpbWVJbnRlcnZhbCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuTW9kZWxzLkVudW1lcmF0b3JzLkNhbmRsZVRpbWVJbnRlcnZhbCIsIlByZWRlZmluZWRWYWx1ZXMiOlt7IktleSI6IjAiLCJWYWx1ZSI6IlVuc3BlY2lmaWVkIn0seyJLZXkiOiIxIiwiVmFsdWUiOiJTZWMifSx7IktleSI6IjYwIiwiVmFsdWUiOiJNaW51dGUifSx7IktleSI6IjMwMCIsIlZhbHVlIjoiTWluNSJ9LHsiS2V5IjoiOTAwIiwiVmFsdWUiOiJNaW4xNSJ9LHsiS2V5IjoiMTgwMCIsIlZhbHVlIjoiTWluMzAifSx7IktleSI6IjM2MDAiLCJWYWx1ZSI6IkhvdXIifSx7IktleSI6IjE0NDAwIiwiVmFsdWUiOiJIb3VyNCJ9LHsiS2V5IjoiMjE2MDAiLCJWYWx1ZSI6IkhvdXI2In0seyJLZXkiOiI0MzIwMCIsIlZhbHVlIjoiSG91cjEyIn0seyJLZXkiOiI4NjQwMCIsIlZhbHVlIjoiRGF5In0seyJLZXkiOiI2MDQ4MDAiLCJWYWx1ZSI6IldlZWsifSx7IktleSI6IjMwMDAwMDAiLCJWYWx1ZSI6Ik1vbnRoIn1dfV19XX0=", base64Result);
        }

        [Test]
        public void ExtractMetadata_FromMovingAverageCrossAlgo_Succeeds_WhenAlgoProperlyImplemented()
        {
            var base64Content =
                "dXNpbmcgTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkNvcmUuRG9tYWluOw0KdXNpbmcgTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkZ1bmN0aW9ucy5BRFg7DQp1c2luZyBMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5BYnN0cmFjdGlvbnMuRnVuY3Rpb25zLlNNQTsNCg0KbmFtZXNwYWNlIEx5a2tlLkFsZ29TdG9yZS5DU2hhcnAuQWxnby5JbXBsZW1lbnRpb24NCnsNCiAgICAvLy8gPHN1bW1hcnk+DQogICAgLy8vIE1vdmluZyBBdmVyYWdlIENyb3NzIEFsZ29yaXRobQ0KICAgIC8vLyA8L3N1bW1hcnk+DQogICAgc2VhbGVkIGNsYXNzIE1vdmluZ0F2ZXJhZ2VDcm9zc0FsZ28gOiBCYXNlQWxnbw0KICAgIHsNCiAgICAgICAgcHVibGljIGludCBBRFhUaHJlc2hvbGQgeyBnZXQ7IHNldDsgfQ0KDQogICAgICAgIHByaXZhdGUgYm9vbCBfY3Jvc3NTTUFTaG9ydEFib3ZlOw0KICAgICAgICBwcml2YXRlIGJvb2wgX2Nyb3NzU01BU2hvcnRCZWxvdzsNCg0KICAgICAgICBwcml2YXRlIGRvdWJsZSBfbGFzdFNNQVNob3J0Ow0KICAgICAgICBwcml2YXRlIGRvdWJsZSBfbGFzdFNNQUxvbmc7DQogICAgICAgIHByaXZhdGUgZG91YmxlPyBfbGFzdEFEWFZhbHVlOw0KDQogICAgICAgIHByaXZhdGUgZG91YmxlIF9jdXJyZW50U01BU2hvcnQ7DQogICAgICAgIHByaXZhdGUgZG91YmxlIF9jdXJyZW50U01BTG9uZzsNCiAgICAgICAgcHJpdmF0ZSBkb3VibGU/IF9jdXJyZW50QURYOw0KDQogICAgICAgIHB1YmxpYyBTbWFGdW5jdGlvbiBfc21hU2hvcnRQZXJpb2Q7DQogICAgICAgIHB1YmxpYyBTbWFGdW5jdGlvbiBfc21hTG9uZ1BlcmlvZDsNCiAgICAgICAgcHVibGljIEFkeEZ1bmN0aW9uIF9hZHg7DQoNCiAgICAgICAgcHVibGljIG92ZXJyaWRlIHZvaWQgT25TdGFydFVwKElGdW5jdGlvblByb3ZpZGVyIGZ1bmN0aW9ucykNCiAgICAgICAgew0KICAgICAgICAgICAgX3NtYVNob3J0UGVyaW9kID0gZnVuY3Rpb25zLkdldEZ1bmN0aW9uPFNtYUZ1bmN0aW9uPigiU01BX1Nob3J0Iik7DQogICAgICAgICAgICBfc21hTG9uZ1BlcmlvZCA9IGZ1bmN0aW9ucy5HZXRGdW5jdGlvbjxTbWFGdW5jdGlvbj4oIlNNQV9Mb25nIik7DQogICAgICAgICAgICBfYWR4ID0gZnVuY3Rpb25zLkdldEZ1bmN0aW9uPEFkeEZ1bmN0aW9uPigiQURYIik7DQoNCiAgICAgICAgICAgIF9jdXJyZW50U01BU2hvcnQgPSBfc21hU2hvcnRQZXJpb2QuVmFsdWUgPz8gMDsNCiAgICAgICAgICAgIF9jdXJyZW50U01BTG9uZyA9IF9zbWFMb25nUGVyaW9kLlZhbHVlID8/IDA7DQogICAgICAgICAgICBfY3VycmVudEFEWCA9IF9hZHguVmFsdWU7DQoNCiAgICAgICAgICAgIF9sYXN0U01BTG9uZyA9IF9jdXJyZW50U01BTG9uZzsNCiAgICAgICAgICAgIF9sYXN0U01BU2hvcnQgPSBfY3VycmVudFNNQVNob3J0Ow0KICAgICAgICAgICAgX2xhc3RBRFhWYWx1ZSA9IF9jdXJyZW50QURYOw0KICAgICAgICB9DQoNCiAgICAgICAgcHVibGljIG92ZXJyaWRlIHZvaWQgT25DYW5kbGVSZWNlaXZlZChJQ2FuZGxlQ29udGV4dCBjb250ZXh0Q2FuZGxlKQ0KICAgICAgICB7DQogICAgICAgICAgICBjb250ZXh0Q2FuZGxlLkFjdGlvbnMuTG9nKCQiQWxnbyBBRFggVGhyZXNob2xkIHtBRFhUaHJlc2hvbGR9Iik7DQogICAgICAgICAgICBjb250ZXh0Q2FuZGxlLkFjdGlvbnMuTG9nKCQiU01BX1Nob3J0IEFzc2V0IFBhaXI6IHtfc21hU2hvcnRQZXJpb2QuRnVuY3Rpb25QYXJhbWV0ZXJzLkFzc2V0UGFpcn0sICIgKw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkIlNNQV9Mb25nIEFzc2V0IFBhaXI6IHtfc21hTG9uZ1BlcmlvZC5GdW5jdGlvblBhcmFtZXRlcnMuQXNzZXRQYWlyfSIpOw0KDQogICAgICAgICAgICBfY3VycmVudFNNQVNob3J0ID0gX3NtYVNob3J0UGVyaW9kLlZhbHVlID8/IDA7DQogICAgICAgICAgICBfY3VycmVudFNNQUxvbmcgPSBfc21hTG9uZ1BlcmlvZC5WYWx1ZSA/PyAwOw0KICAgICAgICAgICAgX2N1cnJlbnRBRFggPSBfYWR4LlZhbHVlOw0KDQogICAgICAgICAgICBfY3Jvc3NTTUFTaG9ydEFib3ZlID0gZmFsc2U7DQogICAgICAgICAgICBfY3Jvc3NTTUFTaG9ydEJlbG93ID0gZmFsc2U7DQoNCiAgICAgICAgICAgIGNvbnRleHRDYW5kbGUuQWN0aW9ucy5Mb2coJCJGdW5jdGlvbiB2YWx1ZXMgYXJlOiBTTUFfU2hvcnQ6IHtfY3VycmVudFNNQVNob3J0fSwgU01BX0xvbmc6IHtfY3VycmVudFNNQUxvbmd9LCBBRFg6IHtfY3VycmVudEFEWH0iKTsNCg0KDQogICAgICAgICAgICAvL3dlIHdhbnQgdG8gbWFyayB0aGUgY3Jvc3MgYW5kIGxhdGVyIGNoZWNrIGlmIHRoZXJlIGlzIGFkeA0KICAgICAgICAgICAgaWYgKF9sYXN0U01BU2hvcnQgPCBfbGFzdFNNQUxvbmcgJiYgX2N1cnJlbnRTTUFTaG9ydCA+IF9jdXJyZW50U01BTG9uZykNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICBjb250ZXh0Q2FuZGxlLkFjdGlvbnMuTG9nKCQiQ3Jvc3MgYWJvdmUgb2YgdGhlIFNNQSBzaG9ydCBwZXJpb2QgZnVuY3Rpb24gPT4gU01BX1Nob3J0OiB7X2N1cnJlbnRTTUFTaG9ydH0sIFNNQV9Mb25nOiB7X2N1cnJlbnRTTUFMb25nfSIpOw0KICAgICAgICAgICAgICAgIF9jcm9zc1NNQVNob3J0QWJvdmUgPSB0cnVlOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAoX2xhc3RTTUFTaG9ydCA+IF9sYXN0U01BTG9uZyAmJiBfY3VycmVudFNNQVNob3J0IDwgX2N1cnJlbnRTTUFMb25nKQ0KICAgICAgICAgICAgew0KICAgICAgICAgICAgICAgIGNvbnRleHRDYW5kbGUuQWN0aW9ucy5Mb2coJCJDcm9zcyBiZWxvdyBvZiB0aGUgU01BIHNob3J0IHBlcmlvZCBmdW5jdGlvbiA9PiBTTUFfU2hvcnQ6IHtfY3VycmVudFNNQVNob3J0fSwgU01BX0xvbmc6IHtfY3VycmVudFNNQUxvbmd9Iik7DQogICAgICAgICAgICAgICAgX2Nyb3NzU01BU2hvcnRCZWxvdyA9IHRydWU7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vaWYgd2UgaGF2ZSBhZHggYW5kIGNyb3NzIHdlIGNhbiBidXkvc2VsbA0KICAgICAgICAgICAgLy9UT0RPIHdlIHNob3VsZCBzZXQgaW4gcGFyYW1ldGVyIHZhbHVlIGZvciBzZWxsIGFuZCBidXkgaWYgDQogICAgICAgICAgICAvL2l0IGlzIG9uZSBhbmQgdGhlIHNhbWUgd2UgY2FuIHVzZSBkZWxlZ2F0ZXMgZm9yIGNhbGxpbmcgdHJhZGluZyBtZXRob2RzDQoNCiAgICAgICAgICAgIGlmIChfY3VycmVudEFEWC5IYXNWYWx1ZSAmJiBfY3VycmVudEFEWCA+IEFEWFRocmVzaG9sZCkNCiAgICAgICAgICAgIHsNCiAgICAgICAgICAgICAgICBpZiAoX2Nyb3NzU01BU2hvcnRBYm92ZSkNCiAgICAgICAgICAgICAgICB7DQogICAgICAgICAgICAgICAgICAgIGNvbnRleHRDYW5kbGUuQWN0aW9ucy5Mb2coJCJDcm9zcyBhYm92ZSBhbmQgQURYIG9jY3VycmVkIEJVWSA9PiBTTUFfU2hvcnQ6IHtfY3VycmVudFNNQVNob3J0fSwgU01BX0xvbmc6IHtfY3VycmVudFNNQUxvbmd9Iik7DQogICAgICAgICAgICAgICAgICAgIC8vY29udGV4dC5BY3Rpb25zLkJ1eVN0cmFpZ2h0KHBhcmFtZXRlci5WYWx1ZVRvQnV5KTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBpZiAoX2Nyb3NzU01BU2hvcnRCZWxvdykNCiAgICAgICAgICAgICAgICAgICAgY29udGV4dENhbmRsZS5BY3Rpb25zLkxvZygkIkNyb3NzIGJlbG93IGFuZCBBRFggb2NjdXJyZWQgU0VMTCA9PiBTTUFfU2hvcnQ6IHtfY3VycmVudFNNQVNob3J0fSwgU01BX0xvbmc6IHtfY3VycmVudFNNQUxvbmd9Iik7DQogICAgICAgICAgICAgICAgLy9jb250ZXh0LkFjdGlvbnMuU2VsbFN0cmFpZ2h0KHBhcmFtZXRlci5WYWx1ZVRvU2VsbCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIF9sYXN0U01BTG9uZyA9IF9jdXJyZW50U01BTG9uZzsNCiAgICAgICAgICAgIF9sYXN0U01BU2hvcnQgPSBfY3VycmVudFNNQVNob3J0Ow0KICAgICAgICAgICAgX2xhc3RBRFhWYWx1ZSA9IF9jdXJyZW50QURYOw0KICAgICAgICB9DQoNCiAgICAgICAgcHVibGljIGRvdWJsZSBHZXRTTUFTaG9ydFRlcm0oKSA9PiBfY3VycmVudFNNQVNob3J0Ow0KDQogICAgICAgIHB1YmxpYyBkb3VibGUgR2V0U01BTG9uZ1Rlcm0oKSA9PiBfY3VycmVudFNNQUxvbmc7DQoNCiAgICAgICAgcHVibGljIGRvdWJsZT8gR2V0QURYKCkgPT4gX2N1cnJlbnRBRFg7DQoNCiAgICAgICAgcHVibGljIGJvb2wgR2V0Q3Jvc3NTTUFTaG9ydEJlbG93KCkgPT4gX2Nyb3NzU01BU2hvcnRCZWxvdzsNCg0KICAgICAgICBwdWJsaWMgYm9vbCBHZXRDcm9zc1NNQVNob3J0QWJvdmUoKSA9PiBfY3Jvc3NTTUFTaG9ydEFib3ZlOw0KICAgIH0NCn0NCg==";
            var code = Encoding.UTF8.GetString(Convert.FromBase64String(base64Content));
            var session = GetCSharpCodeBuildSession(code);

            var validationResult = session.Validate().Result;

            Assert.AreEqual(true, validationResult.IsSuccessful);

            var metadata = session.ExtractMetadata().Result;
            var result = JsonConvert.SerializeObject(metadata);

            var base64Result = Convert.ToBase64String(Encoding.UTF8.GetBytes(result));

            Assert.AreEqual("eyJQYXJhbWV0ZXJzIjpbeyJLZXkiOiJBRFhUaHJlc2hvbGQiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5JbnQzMiIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQXNzZXRQYWlyIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uU3RyaW5nIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJDYW5kbGVJbnRlcnZhbCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuTW9kZWxzLkVudW1lcmF0b3JzLkNhbmRsZVRpbWVJbnRlcnZhbCIsIlByZWRlZmluZWRWYWx1ZXMiOlt7IktleSI6IjAiLCJWYWx1ZSI6IlVuc3BlY2lmaWVkIn0seyJLZXkiOiIxIiwiVmFsdWUiOiJTZWMifSx7IktleSI6IjYwIiwiVmFsdWUiOiJNaW51dGUifSx7IktleSI6IjMwMCIsIlZhbHVlIjoiTWluNSJ9LHsiS2V5IjoiOTAwIiwiVmFsdWUiOiJNaW4xNSJ9LHsiS2V5IjoiMTgwMCIsIlZhbHVlIjoiTWluMzAifSx7IktleSI6IjM2MDAiLCJWYWx1ZSI6IkhvdXIifSx7IktleSI6IjE0NDAwIiwiVmFsdWUiOiJIb3VyNCJ9LHsiS2V5IjoiMjE2MDAiLCJWYWx1ZSI6IkhvdXI2In0seyJLZXkiOiI0MzIwMCIsIlZhbHVlIjoiSG91cjEyIn0seyJLZXkiOiI4NjQwMCIsIlZhbHVlIjoiRGF5In0seyJLZXkiOiI2MDQ4MDAiLCJWYWx1ZSI6IldlZWsifSx7IktleSI6IjMwMDAwMDAiLCJWYWx1ZSI6Ik1vbnRoIn1dfSx7IktleSI6IlN0YXJ0RnJvbSIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRhdGVUaW1lIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJFbmRPbiIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkRhdGVUaW1lIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJWb2x1bWUiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5Eb3VibGUiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IlRyYWRlZEFzc2V0IiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uU3RyaW5nIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH1dLCJGdW5jdGlvbnMiOlt7IlR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5BYnN0cmFjdGlvbnMuRnVuY3Rpb25zLlNNQS5TbWFGdW5jdGlvbiIsIklkIjoiX3NtYVNob3J0UGVyaW9kIiwiRnVuY3Rpb25QYXJhbWV0ZXJUeXBlIjoiTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkZ1bmN0aW9ucy5TTUEuU21hUGFyYW1ldGVycyIsIlBhcmFtZXRlcnMiOlt7IktleSI6IlNob3J0VGVybVBlcmlvZCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkludDMyIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJMb25nVGVybVBlcmlvZCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkludDMyIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJEZWNpbWFscyIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLk51bGxhYmxlYDFbW1N5c3RlbS5JbnQzMiwgU3lzdGVtLlByaXZhdGUuQ29yZUxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTdjZWM4NWQ3YmVhNzc5OGVdXSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQ2FwYWNpdHkiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5JbnQzMiIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQXNzZXRQYWlyIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uU3RyaW5nIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJDYW5kbGVPcGVyYXRpb25Nb2RlIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5BYnN0cmFjdGlvbnMuQ29yZS5GdW5jdGlvbnMuRnVuY3Rpb25QYXJhbXNCYXNlK0NhbmRsZVZhbHVlIiwiUHJlZGVmaW5lZFZhbHVlcyI6W3siS2V5IjoiMCIsIlZhbHVlIjoiT1BFTiJ9LHsiS2V5IjoiMSIsIlZhbHVlIjoiQ0xPU0UifSx7IktleSI6IjIiLCJWYWx1ZSI6IkxPVyJ9LHsiS2V5IjoiMyIsIlZhbHVlIjoiSElHSCJ9XX0seyJLZXkiOiJGdW5jdGlvbkluc3RhbmNlSWRlbnRpZmllciIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLlN0cmluZyIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiU3RhcnRpbmdEYXRlIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uRGF0ZVRpbWUiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkVuZGluZ0RhdGUiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5EYXRlVGltZSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQ2FuZGxlVGltZUludGVydmFsIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5Nb2RlbHMuRW51bWVyYXRvcnMuQ2FuZGxlVGltZUludGVydmFsIiwiUHJlZGVmaW5lZFZhbHVlcyI6W3siS2V5IjoiMCIsIlZhbHVlIjoiVW5zcGVjaWZpZWQifSx7IktleSI6IjEiLCJWYWx1ZSI6IlNlYyJ9LHsiS2V5IjoiNjAiLCJWYWx1ZSI6Ik1pbnV0ZSJ9LHsiS2V5IjoiMzAwIiwiVmFsdWUiOiJNaW41In0seyJLZXkiOiI5MDAiLCJWYWx1ZSI6Ik1pbjE1In0seyJLZXkiOiIxODAwIiwiVmFsdWUiOiJNaW4zMCJ9LHsiS2V5IjoiMzYwMCIsIlZhbHVlIjoiSG91ciJ9LHsiS2V5IjoiMTQ0MDAiLCJWYWx1ZSI6IkhvdXI0In0seyJLZXkiOiIyMTYwMCIsIlZhbHVlIjoiSG91cjYifSx7IktleSI6IjQzMjAwIiwiVmFsdWUiOiJIb3VyMTIifSx7IktleSI6Ijg2NDAwIiwiVmFsdWUiOiJEYXkifSx7IktleSI6IjYwNDgwMCIsIlZhbHVlIjoiV2VlayJ9LHsiS2V5IjoiMzAwMDAwMCIsIlZhbHVlIjoiTW9udGgifV19XX0seyJUeXBlIjoiTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkZ1bmN0aW9ucy5TTUEuU21hRnVuY3Rpb24iLCJJZCI6Il9zbWFMb25nUGVyaW9kIiwiRnVuY3Rpb25QYXJhbWV0ZXJUeXBlIjoiTHlra2UuQWxnb1N0b3JlLkNTaGFycC5BbGdvVGVtcGxhdGUuQWJzdHJhY3Rpb25zLkZ1bmN0aW9ucy5TTUEuU21hUGFyYW1ldGVycyIsIlBhcmFtZXRlcnMiOlt7IktleSI6IlNob3J0VGVybVBlcmlvZCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkludDMyIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJMb25nVGVybVBlcmlvZCIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLkludDMyIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJEZWNpbWFscyIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLk51bGxhYmxlYDFbW1N5c3RlbS5JbnQzMiwgU3lzdGVtLlByaXZhdGUuQ29yZUxpYiwgVmVyc2lvbj00LjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTdjZWM4NWQ3YmVhNzc5OGVdXSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQ2FwYWNpdHkiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5JbnQzMiIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQXNzZXRQYWlyIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uU3RyaW5nIiwiUHJlZGVmaW5lZFZhbHVlcyI6bnVsbH0seyJLZXkiOiJDYW5kbGVPcGVyYXRpb25Nb2RlIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5BYnN0cmFjdGlvbnMuQ29yZS5GdW5jdGlvbnMuRnVuY3Rpb25QYXJhbXNCYXNlK0NhbmRsZVZhbHVlIiwiUHJlZGVmaW5lZFZhbHVlcyI6W3siS2V5IjoiMCIsIlZhbHVlIjoiT1BFTiJ9LHsiS2V5IjoiMSIsIlZhbHVlIjoiQ0xPU0UifSx7IktleSI6IjIiLCJWYWx1ZSI6IkxPVyJ9LHsiS2V5IjoiMyIsIlZhbHVlIjoiSElHSCJ9XX0seyJLZXkiOiJGdW5jdGlvbkluc3RhbmNlSWRlbnRpZmllciIsIlZhbHVlIjpudWxsLCJUeXBlIjoiU3lzdGVtLlN0cmluZyIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiU3RhcnRpbmdEYXRlIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJTeXN0ZW0uRGF0ZVRpbWUiLCJQcmVkZWZpbmVkVmFsdWVzIjpudWxsfSx7IktleSI6IkVuZGluZ0RhdGUiLCJWYWx1ZSI6bnVsbCwiVHlwZSI6IlN5c3RlbS5EYXRlVGltZSIsIlByZWRlZmluZWRWYWx1ZXMiOm51bGx9LHsiS2V5IjoiQ2FuZGxlVGltZUludGVydmFsIiwiVmFsdWUiOm51bGwsIlR5cGUiOiJMeWtrZS5BbGdvU3RvcmUuQ1NoYXJwLkFsZ29UZW1wbGF0ZS5Nb2RlbHMuRW51bWVyYXRvcnMuQ2FuZGxlVGltZUludGVydmFsIiwiUHJlZGVmaW5lZFZhbHVlcyI6W3siS2V5IjoiMCIsIlZhbHVlIjoiVW5zcGVjaWZpZWQifSx7IktleSI6IjEiLCJWYWx1ZSI6IlNlYyJ9LHsiS2V5IjoiNjAiLCJWYWx1ZSI6Ik1pbnV0ZSJ9LHsiS2V5IjoiMzAwIiwiVmFsdWUiOiJNaW41In0seyJLZXkiOiI5MDAiLCJWYWx1ZSI6Ik1pbjE1In0seyJLZXkiOiIxODAwIiwiVmFsdWUiOiJNaW4zMCJ9LHsiS2V5IjoiMzYwMCIsIlZhbHVlIjoiSG91ciJ9LHsiS2V5IjoiMTQ0MDAiLCJWYWx1ZSI6IkhvdXI0In0seyJLZXkiOiIyMTYwMCIsIlZhbHVlIjoiSG91cjYifSx7IktleSI6IjQzMjAwIiwiVmFsdWUiOiJIb3VyMTIifSx7IktleSI6Ijg2NDAwIiwiVmFsdWUiOiJEYXkifSx7IktleSI6IjYwNDgwMCIsIlZhbHVlIjoiV2VlayJ9LHsiS2V5IjoiMzAwMDAwMCIsIlZhbHVlIjoiTW9udGgifV19XX1dfQ==", base64Result);
        }

        private ICodeBuildSession GetCSharpCodeBuildSession(string code)
        {
            var codeValidationService = new CodeBuildService();
            var session = codeValidationService.StartSession(code);

            return session;
        }

        private ValidationResult When_Code_IsSyntaxValidated(string code)
        {
            var codeValidationService = new CodeBuildService();
            var session = codeValidationService.StartSession(code);

            return session.Validate().Result;
        }

        private void Then_Result_MustContainMessage(ValidationResult result, string messageId)
        {
            Assert.IsTrue(result.Messages.Any(m => m.Id == messageId));
        }

        private void Then_Result_MustFailAndContainMessages(ValidationResult result)
        {
            Assert.AreEqual(false, result.IsSuccessful);
            Assert.IsTrue(result.Messages.Count > 0);
        }

        private void Then_Result_MustSucceedAndContainNoMessages(ValidationResult result)
        {
            Assert.AreEqual(true, result.IsSuccessful);
            Assert.IsTrue(result.Messages.Count == 0);
        }

        private void Then_Result_MustContainMessageNTimes(ValidationResult result, string messageId, int count)
        {
            Assert.AreEqual(count, result.Messages.Where(m => m.Id == messageId).Count());
        }
    }
}
